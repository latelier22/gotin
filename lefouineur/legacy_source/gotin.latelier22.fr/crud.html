<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>CRUD Montres</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Styles -->
  <link rel="stylesheet" href="styles/crud.css">

  <!-- Mini styles nécessaires pour la colonne Marque -->
  <style>
    .brand-cell { display:inline-flex; align-items:center; gap:8px; min-width:0; }
    .brand-logo { width:22px; height:22px; object-fit:contain; background:#0f0f0f; border:1px solid #555; border-radius:4px; padding:2px; }
    .brand-name { display:inline-block; max-width:14ch; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  </style>

  <!-- Scripts (ORDRE IMPORTANT) -->
  <script>window.API_URL = "api.php";</script>
  <script src="js/marque.js?v=3" defer></script>
  <script src="js/crud.js?v=3" defer></script>

  <!-- ZIP (optionnel) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip-utils/0.1.0/jszip-utils.min.js"></script>
  <!-- <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script> -->
  <script src="https://cdn.ckeditor.com/ckeditor5/41.4.2/classic/ckeditor.js"></script>

</head>

<body>

  <h1>Gestion des produits</h1>

  <div>
    <button onclick="window.location.href='index.html'">🏠 Voir les produits</button>
    <button onclick="openBrandModal()">🏷️ Marques</button>
    <button onclick="openAddModal()">➕ Ajouter un produit</button>
    <button onclick="sendSQLiteDataToServer()">📤 Envoyer données vers serveur</button>
    <button onclick="window.location.href='data/montres.csv'">📥 Télécharger données csv</button>
  </div>

  <div id="filters-container" style="display: flex; align-items: center; gap: 8px;"></div>
  <div id="filters" style="margin-bottom: 12px;">
    <button onclick="filterCategory('All')">📦 Tous</button>
    <button onclick="filterCategory('Montres')">⌚ Montres</button>
    <button onclick="filterCategory('Chaussures')">👟 Chaussures</button>
    <button onclick="filterCategory('Autres')">📁 Autres</button>
  </div>
  <button id="toggle-active-btn" data-mode="all" style="margin-left: auto;">
    Afficher : Tous
  </button>
  </div>

  <table>
    <colgroup>
      <col style="width:6%">
      <col style="width:8%">
      <col style="width:10%">
      <col style="width:7%">
      <col style="width:7%">
      <col style="width:7%"> <!-- Prix conseillé -->
      <col style="width:6%"> <!-- Ajust % -->
      <col style="width:12%">
      <col style="width:16%">
      <col style="width:18%">
      <col style="width:4%">
      <col style="width:3%">
      <col style="width:3%">
      <col style="width:3%">
      <col style="width:2%">
    </colgroup>

    <thead>
      <tr>
        <th>Reference</th>
        <th>Marque</th>
        <th>Nom</th>
        <th>Prix conseillé</th>
        <th>Prix</th>
        <th>Promotion</th>
        <th>Courte description</th>
        <th class="col-description">Description</th>
        <th>Images</th>
        <th>Actif</th>
        <th>Actions</th>
        <th>Catégorie</th>
        <th>État</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="montreTable"></tbody>
  </table>

  <!-- Modale Slider -->
  <div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.85); z-index:1100; justify-content:center; align-items:center; flex-direction:column;">
    <button class="close" onclick="closeModal()" style="position:absolute; top:10px; right:10px;">✖</button>
    <img id="modal-image" alt="" style="max-width:100vw; max-height:100vh; margin-bottom:10px;">
    <div>
      <button onclick="prevImage()">⬅️</button>
      <button onclick="nextImage()">➡️</button>
    </div>
  </div>

  <!-- Mini-modale d'édition d'image -->
  <div id="editImageModal" class="img-edit-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:1001; align-items:center; justify-content:center;">
    <div class="img-edit-modal-content" style="background:#fff; padding:12px; border-radius:8px; max-width:90vw; max-height:90vh; display:grid; gap:10px; grid-template-rows:auto 1fr auto; position:relative;">
      <button class="close" onclick="closeEditImageModal()" style="position:absolute; top:12px; right:12px;">✖</button>
      <img id="editImageModalImg" alt="" style="max-width:70vw; max-height:70vh; object-fit:contain;">
      <div class="actions" style="display:flex; gap:10px; justify-content:center;">
        <button type="button" onclick="triggerReplace()">📁 Remplacer</button>
        <button type="button" onclick="deleteCurrentSlot()">🗑️ Supprimer</button>
      </div>
    </div>
  </div>

  <!-- Input caché pour remplacement ciblé -->
  <input type="file" id="replaceImageInput" accept="image/*" style="display:none">

  <!-- Modale Formulaire produit -->
<!-- Modale Formulaire produit -->
<div id="formModal" style="display:none; position:fixed; inset:0; background:#000c; z-index:900; justify-content:center; align-items:center;">
  <div class="modal-sheet">
    <form id="formMontre" enctype="multipart/form-data" style="background:#222; padding:20px; color:#fff; width:100%; border-radius:10px;">
      <input type="hidden" name="id">

      <label>Reference :
        <input type="text" name="reference" required>
      </label>

      <label>Marque :
        <div class="d-flex gap-2">
          <select name="marque" id="brandSelect" required>
            <option value="" selected disabled>— Choisir une marque —</option>
          </select>
          <button type="button" onclick="openBrandModal()">+ Ajouter</button>
        </div>
      </label>

      <label>Nom :
        <input type="text" name="nom" required>
      </label>

      <label>Prix :
        <input type="number" name="prix" required>
      </label>

      <label>Prix conseillé :
        <input type="number" name="prix_conseille" required>
      </label>

      <label>Promotion :
        <input type="number" name="promotion" placeholder="entrer le nouveau prix">
      </label>

      <label>Courte description :
        <textarea name="short_description" rows="2" maxlength="160" placeholder="Résumé court (max 160)"></textarea>
      </label>

      <label for="description">Description longue :</label>
      <textarea id="description" name="description" rows="10"></textarea>

      <label>Images :
        <input type="file" name="images" accept="image/*" multiple>
      </label>
      <div id="imagesPreview" class="thumbs"></div>

      <label>Catégorie :
        <select name="categorie">
          <option>Montres</option>
          <option>Chaussures</option>
          <option>Autres</option>
        </select>
      </label>

      <label>Etat :
        <input type="text" name="etat" value="Neuf" required>
      </label>

      <label>Status :
        <select name="status">
          <option value="disponible">Disponible</option>
          <option value="achat en cours">Achat en cours</option>
          <option value="vendu">Vendu</option>
        </select>
      </label>

      <label>
        <input type="checkbox" name="active" checked>
        Actif (visible)
      </label>  

      <div style="margin-top:10px; display:flex; gap:8px;">
        <button type="submit">💾 Enregistrer</button>
        <button type="button" onclick="closeModalForm()">❌ Annuler</button>
      </div>
    </form>
  </div>
</div>

  <!-- Spinner -->
  <div id="spinner" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:1200; justify-content:center; align-items:center;">
    <div style="border:6px solid #FFD700; border-top:6px solid transparent; border-radius:50%; width:60px; height:60px; animation:spin 1s linear infinite;"></div>
  </div>

  <!-- Modale Marques -->
<!-- Modale Marques -->
<div id="brandModal" class="img-edit-modal" style="display:none;">
  <div class="img-edit-modal-content">
    <button class="close" onclick="closeBrandModal()">✖</button>
    <h3 style="margin:0">Marques</h3>

    <!-- 👉👉 CE TABLEAU DOIT EXISTER 👇 -->
    <table style="width:100%; border-collapse:collapse;">
      <thead>
        <tr>
          <th style="text-align:left; padding:6px; border-bottom:1px solid #ddd;">Logo</th>
          <th style="text-align:left; padding:6px; border-bottom:1px solid #ddd;">Nom</th>
          <th style="text-align:left; padding:6px; border-bottom:1px solid #ddd;">Actions</th>
        </tr>
      </thead>
      <tbody id="brandTable"></tbody>
    </table>
    <!-- 👆👆 -->

    <hr style="border:none; border-top:1px solid #eee">

    <form id="formBrand">
      <input type="hidden" name="brand_id">
      <div>
        <label>Nom de la marque</label>
        <input type="text" name="brand_name" placeholder="Ex: Omega" required>
      </div>
      <div>
        <label>Logo (PNG/JPG/WebP)</label>
        <input type="file" id="brandLogoInput" accept="image/*">
        <div id="brandLogoPreview" style="margin-top:8px;"></div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button type="submit">💾 Enregistrer</button>
        <button type="button" onclick="resetBrandForm()">↺ Nouvelle marque</button>
        <button type="button" onclick="closeBrandModal()">Annuler</button>
      </div>
    </form>
  </div>
</div>


  <style>@keyframes spin { to { transform: rotate(360deg); } }</style>


<style>
  /* Force le texte en NOIR dans l’éditeur uniquement */
  .ck-editor__editable,
  .ck-content {
    background: #fff !important;  /* si tu veux fond blanc */
    color: #000 !important;        /* texte noir */
  }

  /* (Optionnel) titres & listes bien visibles */
  .ck-content h1, .ck-content h2, .ck-content h3,
  .ck-content h4, .ck-content h5, .ck-content h6,
  .ck-content p,  .ck-content ul, .ck-content ol {
    color: #000 !important;
  }

  /* (Optionnel) placeholder plus lisible */
  .ck-placeholder {
    color: #666 !important;
  }
</style>

 <script>
let __ck = null;                 // <- instance accessible partout
let __ckReady = null;            // <- promesse de dispo

ClassicEditor.create(document.querySelector('#description'), {
  toolbar: [
    'undo','redo','|',
    'heading','|',
    'bold','italic','underline','|',
    'bulletedList','numberedList','outdent','indent','|',
    'link','insertTable'
  ]
}).then(editor => {
  __ck = editor;
  __ckReady = Promise.resolve(editor);

  // Très important : au submit on renvoie le HTML dans le textarea
  const form = document.getElementById('formMontre');
  if (form) {
    form.addEventListener('submit', () => {
      document.getElementById('description').value = editor.getData();
    });
  }
}).catch(console.error);
</script>

</body>
</html>
