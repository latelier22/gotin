<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <title>Mise √† jour des Montres</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            background-color: #111;
            color: #FFD700;
            padding: 20px;
            text-align: center;
        }

        h1 {
            color: #FFD700;
            margin-bottom: 20px;
        }

        table {
            margin: auto;
            border-collapse: collapse;
            width: 90%;
            background: #222;
            color: white;
        }

        th,
        td {
            border: 1px solid #555;
            padding: 10px;
        }

        img {
            height: 100px;
            border-radius: 6px;
        }

        button,
        label.upload {
            margin: 10px;
            padding: 12px 25px;
            font-size: 1em;
            cursor: pointer;
            border-radius: 5px;
            border: none;
            background-color: #FFD700;
            color: #111;
            font-weight: bold;
            display: inline-block;
        }

        .buttons {
            margin-top: 20px;
        }

        input[type="file"] {
            display: none;
        }

        .thumbs img {
  height: 100px;
  margin: 2px;
  cursor: pointer;
  border-radius: 5px;
  border: 1px solid #444;
  transition: transform 0.2s;
}
.thumbs img:hover {
  transform: scale(1.1);
}

    </style>
</head>

<body>

    <h1>Exporter ou mettre √† jour les montres</h1>

    <div class="buttons">
        <button onclick="window.location.href='https://docs.google.com/spreadsheets/d/1RImwBSEucX0d6chHduucER-GVvM_nzlSFmvAjlQnScg/edit?usp=sharing'">GoogleSheet</button>
        <button onclick="downloadCSV()">‚¨áÔ∏è T√©l√©charge rmontres de GoogleSheet</button>

        <button onclick="replaceCSVFromData()">üì§ Exporter Montres Google vers vers le serveur</button>

        <button onclick="window.location.href='index.html'">üè† Voir les montres</button>
        <button onclick="window.location.href='ajouter.html'">Ajouter une montre</button>
    </div>

    <table id="montreTable">
        <thead>
            <tr>
                <th>Nom</th>
                <th>Prix</th>
                <th>Description</th>
                <th>Image</th>
                <th>üõ†Ô∏è Actions</th>
            </tr>
        </thead>
        <tbody></tbody>

    </table>

    <!-- MODALE √âDITION -->
    <div id="editModal"
        style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:#000c; z-index:9999; justify-content:center; align-items:center;">
        <div
            style="background:#222; padding:20px; color:white; max-width:500px; width:90%; border-radius:10px; position:relative;">
            <h2>Modifier la montre</h2>
            <form id="editForm">
                <input type="hidden" name="index" />
                <label>Nom <input type="text" name="nom" required></label>
                <label>Prix <input type="number" name="prix" required></label>
                <label>Description <textarea name="description" rows="3" required></textarea></label>
                <div>
                    <label>Image 1 <br><img id="imgPreview1" src="" height="50"><br><input type="file" name="image1"
                            accept="image/*"></label><br>
                    <label>Image 2 <br><img id="imgPreview2" src="" height="50"><br><input type="file" name="image2"
                            accept="image/*"></label><br>
                    <label>Image 3 <br><img id="imgPreview3" src="" height="50"><br><input type="file" name="image3"
                            accept="image/*"></label><br>
                    <label>Image 4 <br><img id="imgPreview4" src="" height="50"><br><input type="file" name="image4"
                            accept="image/*"></label>
                </div>
                <button type="submit">üíæ Enregistrer</button>
                <button type="button" onclick="closeEditModal()">‚ùå Annuler</button>
            </form>
        </div>
    </div>

    <!-- MODALE POUR SLIDER -->
<div id="modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.85); z-index:1000; justify-content:center; align-items:center; flex-direction:column;">
  <button onclick="closeModal()" style="position:absolute; top:10px; right:10px; background:#FFD700; color:#111; font-weight:bold; font-size:20px; border:none; border-radius:5px; padding:5px 10px; cursor:pointer;">‚úñ</button>
  <img id="modal-image" src="" style="max-width:80vw; max-height:80vh; margin-bottom:10px;" />
  <div>
    <button onclick="prevImage()" style="margin:10px; font-size:25px;">‚¨ÖÔ∏è</button>
    <button onclick="nextImage()" style="margin:10px; font-size:25px;">‚û°Ô∏è</button>
  </div>
</div>

<div id="spinner" style="
  display:none;
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.7);
  z-index:9999;
  justify-content:center;
  align-items:center;
">
  <div style="border:6px solid #FFD700; border-top:6px solid transparent; border-radius:50%; width:60px; height:60px; animation:spin 1s linear infinite;"></div>
</div>

<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>






    <script src="js/config.js"></script>
    <script>
        let montres = [];

        async function fetchData() {
            try {
                showSpinner();
                const res = await fetch(GOOGLE_API_URL);
                montres = await res.json();
                hideSpinner();
                displayTable();
            } catch (e) {
                hideSpinner();
                alert("Erreur de chargement : " + e);
            }
        }

        function displayTable() {
            const tbody = document.querySelector("#montreTable tbody");
            tbody.innerHTML = "";
            montres.forEach((m, index) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
      <td>${m.nom}</td>
      <td>${m.prix} ‚Ç¨</td>
      <td>${m.description}</td>
     <td>
    <div class="thumbs">
      ${[m.image1, m.image2, m.image3, m.image4].map((img, i) => `
        <img src="${img}" alt="img${i}" onclick="openModal([${[m.image1, m.image2, m.image3, m.image4].map(i => `'${i}'`).join(',')}], ${i})">
      `).join('')}
    </div>
  </td>
     <td>
        <button onclick="openEditModal(${index})">üìù</button>
        <button onclick="deleteMontre(${index})">üóëÔ∏è</button>
    </td>

    `;
                tbody.appendChild(tr);
            });
        }

        function deleteMontre(index) {
  if (!confirm("Supprimer cette montre ?")) return;

  const formData = new FormData();
  formData.append("action", "delete");
  formData.append("id", index);

  showSpinner();

  fetch(GOOGLE_API_URL, {
    method: "POST",
    body: formData
  })
    .then(res => res.text())
    .then(msg => {
      hideSpinner();
      alert("‚õîÔ∏è Montre supprim√©e : " + msg);
      fetchData(); // recharge
    })
    .catch(err => {
      hideSpinner();
      alert("Erreur : " + err);
    });
}

        function downloadCSV() {
            const headers = ["id", "nom", "prix", "description", "image1", "image2", "image3", "image4", "images"];
            const rows = montres.map(r =>
                headers.map(h => {
                    const value = r[h];
                    const str = typeof value === 'string'
                        ? value
                        : typeof value === 'number'
                            ? value.toString()
                            : JSON.stringify(value);
                    return `"${str.replace(/"/g, '""')}"`;
                }).join(",")
            );
            const csvContent = [headers.join(","), ...rows].join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "montres.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function uploadCSV() {
            const fileInput = document.getElementById("csvFile");
            const file = fileInput.files[0];

            if (!file) {
                alert("Veuillez d'abord choisir un fichier CSV !");
                return;
            }

            const formData = new FormData();
            formData.append("csvFile", file);

            fetch("upload.php", {
                method: "POST",
                body: formData
            })
                .then(res => res.text())
                .then(msg => {
                    alert(msg);
                    fileInput.value = "";
                    fetchData();
                })
                .catch(err => {
                    alert("Erreur lors de l'envoi : " + err);
                });
        }

        window.onload = fetchData;


        function openEditModal(index) {
            const montre = montres[index];
            const form = document.getElementById("editForm");

            form.index.value = index;
            form.nom.value = montre.nom;
            form.prix.value = montre.prix;
            form.description.value = montre.description;

            document.getElementById("imgPreview1").src = montre.image1;
            document.getElementById("imgPreview2").src = montre.image2;
            document.getElementById("imgPreview3").src = montre.image3;
            document.getElementById("imgPreview4").src = montre.image4;

            document.getElementById("editModal").style.display = "flex";
        }

        function closeEditModal() {
            document.getElementById("editModal").style.display = "none";
            document.getElementById("editForm").reset();
        }


        function closeEditModal() {
            document.getElementById("editModal").style.display = "none";
        }

        function replaceCSVFromData() {
  const headers = ["id", "nom", "prix", "description", "image1", "image2", "image3", "image4"];
  const rows = montres.map((m, i) =>
    headers.map(h => {
      const value = h === "id" ? i : (m[h] || "");
      const str = typeof value === 'string'
        ? value
        : typeof value === 'number'
        ? value.toString()
        : JSON.stringify(value);
      return `"${str.replace(/"/g, '""')}"`;
    }).join(",")
  );
  const csvContent = [headers.join(","), ...rows].join("\n");
  const blob = new Blob([csvContent], { type: 'text/csv' });
  const formData = new FormData();
  formData.append("csvFile", blob, "montres.csv");
    showSpinner();
  fetch("upload.php", {
    method: "POST",
    body: formData
  })
    .then(res => res.text())
    .then(msg => {
        hideSpinner();
      alert("‚úÖ Fichier CSV mis √† jour sur le serveur :\n" + msg);
    })
    .catch(err => {
        hideSpinner();
      alert("‚ùå Erreur lors de l'envoi : " + err);
    });
}

let currentImages = [];
let currentIndex = 0;

function openModal(images, startIndex) {
  currentImages = images;
  currentIndex = startIndex;
  document.getElementById("modal-image").src = currentImages[currentIndex];
  document.getElementById("modal").style.display = "flex";
}

function closeModal() {
  document.getElementById("modal").style.display = "none";
}

function prevImage() {
  currentIndex = (currentIndex - 1 + currentImages.length) % currentImages.length;
  document.getElementById("modal-image").src = currentImages[currentIndex];
}

function nextImage() {
  currentIndex = (currentIndex + 1) % currentImages.length;
  document.getElementById("modal-image").src = currentImages[currentIndex];
}

function showSpinner() {
  document.getElementById("spinner").style.display = "flex";
}
function hideSpinner() {
  document.getElementById("spinner").style.display = "none";
}

document.getElementById("editForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const form = e.target;
    const index = form.index.value;
    const old = montres[index];

    const formData = new FormData();

    formData.append("action", "edit");
    formData.append("id", index);
    formData.append("nom", form.nom.value);
    formData.append("prix", form.prix.value);
    formData.append("description", form.description.value);

    const imageForm = new FormData();

    for (let i = 1; i <= 4; i++) {
        const file = form[`image${i}`].files[0];
        if (file) {
            formData.append(`image${i}`, "images/" + file.name);
            imageForm.append(`image${i}`, file);
        } else {
            formData.append(`image${i}`, old[`image${i}`]);
        }
    }

    showSpinner();

    try {
        if (imageForm.has("image1") || imageForm.has("image2") || imageForm.has("image3") || imageForm.has("image4")) {
            await fetch("upload-images.php", {
                method: "POST",
                body: imageForm
            });
        }

        const res = await fetch(GOOGLE_API_URL, {
            method: "POST",
            body: formData
        });

        const msg = await res.text();
        alert("‚úÖ Montre modifi√©e : " + msg);
        closeEditModal();
        fetchData();
    } catch (err) {
        alert("‚ùå Erreur lors de la modification : " + err);
    } finally {
        hideSpinner();
    }
});


    </script>
</body>

</html>