<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <title>Mise √† jour des Montres</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            background-color: #111;
            color: #FFD700;
            padding: 20px;
            text-align: center;
        }

        h1 {
            color: #FFD700;
            margin-bottom: 20px;
        }

        table {
            margin: auto;
            border-collapse: collapse;
            width: 90%;
            background: #222;
            color: white;
        }

        th,
        td {
            border: 1px solid #555;
            padding: 10px;
        }

        img {
            height: 60px;
            border-radius: 6px;
        }

        button,
        label.upload {
            margin: 10px;
            padding: 12px 25px;
            font-size: 1em;
            cursor: pointer;
            border-radius: 5px;
            border: none;
            background-color: #FFD700;
            color: #111;
            font-weight: bold;
            display: inline-block;
        }

        .buttons {
            margin-top: 20px;
        }

        input[type="file"] {
            display: none;
        }
    </style>
</head>

<body>

    <h1>Exporter ou mettre √† jour les montres</h1>

    <div class="buttons">
        <button onclick="downloadCSV()">‚¨áÔ∏è T√©l√©charger montres.csv</button>

        <!-- Bouton styl√© d√©clencheur -->
        <input type="file" id="csvFile" name="csvFile" accept=".csv">
        <label for="csvFile" class="upload">üì§ Choisir un fichier CSV</label>
        <button onclick="uploadCSV()">üöÄ Remplacer le CSV sur le serveur</button>

        <button onclick="window.location.href='index.html'">üè† Voir les montres</button>
        <button onclick="window.location.href='ajouter.html'">Ajouter une montre</button>
    </div>

    <table id="montreTable">
        <thead>
            <tr>
                <th>Nom</th>
                <th>Prix</th>
                <th>Description</th>
                <th>Image</th>
                <th>üõ†Ô∏è Actions</th>
            </tr>
        </thead>
        <tbody></tbody>

    </table>
<script src="js/config.js"></script>
    <script>
        let montres = [];

        async function fetchData() {
            try {
                const res = await fetch(GOOGLE_API_URL);
                montres = await res.json();
                displayTable();
            } catch (e) {
                alert("Erreur de chargement : " + e);
            }
        }

        function displayTable() {
            const tbody = document.querySelector("#montreTable tbody");
            tbody.innerHTML = "";
            montres.forEach((m, index) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
      <td>${m.nom}</td>
      <td>${m.prix} ‚Ç¨</td>
      <td>${m.description}</td>
      <td><img src="${m.image2}" alt="${m.nom}"></td>
      <td><button onclick="deleteMontre(${index})">üóëÔ∏è</button></td>
    `;
                tbody.appendChild(tr);
            });
        }

        function deleteMontre(index) {
            if (!confirm("Supprimer cette montre ?")) return;

            fetch(GOOGLE_API_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "delete",
                    id: index
                })
            })
                .then(res => res.text())
                .then(msg => {
                    alert("‚õîÔ∏è Montre supprim√©e : " + msg);
                    fetchData(); // recharge
                })
                .catch(err => {
                    alert("Erreur : " + err);
                });
        }

        function downloadCSV() {
            const headers = ["id", "nom", "prix", "description", "image1", "image2", "image3", "image4", "images"];
            const rows = montres.map(r =>
                headers.map(h => {
                    const value = r[h];
                    const str = typeof value === 'string'
                        ? value
                        : typeof value === 'number'
                            ? value.toString()
                            : JSON.stringify(value);
                    return `"${str.replace(/"/g, '""')}"`;
                }).join(",")
            );
            const csvContent = [headers.join(","), ...rows].join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "montres.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function uploadCSV() {
            const fileInput = document.getElementById("csvFile");
            const file = fileInput.files[0];

            if (!file) {
                alert("Veuillez d'abord choisir un fichier CSV !");
                return;
            }

            const formData = new FormData();
            formData.append("csvFile", file);

            fetch("upload.php", {
                method: "POST",
                body: formData
            })
                .then(res => res.text())
                .then(msg => {
                    alert(msg);
                    fileInput.value = "";
                    fetchData();
                })
                .catch(err => {
                    alert("Erreur lors de l'envoi : " + err);
                });
        }

        window.onload = fetchData;
    </script>
</body>

</html>