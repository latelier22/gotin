<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <title>Mise √† jour des Montres</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            background-color: #111;
            color: #FFD700;
            padding: 20px;
            text-align: center;
        }

        h1 {
            color: #FFD700;
            margin-bottom: 20px;
        }

        table {
            margin: auto;
            border-collapse: collapse;
            width: 90%;
            background: #222;
            color: white;
        }

        th,
        td {
            border: 1px solid #555;
            padding: 10px;
        }

        img {
            height: 60px;
            border-radius: 6px;
        }

        button,
        label.upload {
            margin: 10px;
            padding: 12px 25px;
            font-size: 1em;
            cursor: pointer;
            border-radius: 5px;
            border: none;
            background-color: #FFD700;
            color: #111;
            font-weight: bold;
            display: inline-block;
        }

        .buttons {
            margin-top: 20px;
        }

        input[type="file"] {
            display: none;
        }
    </style>
</head>

<body>

    <h1>Exporter ou mettre √† jour les montres</h1>

    <div class="buttons">
        <button onclick="downloadCSV()">‚¨áÔ∏è T√©l√©charge rmontres de GoogleSheet</button>

        <button onclick="replaceCSVFromData()">üì§ Exporter Montres Google vers vers le serveur</button>

        <button onclick="window.location.href='index.html'">üè† Voir les montres</button>
        <button onclick="window.location.href='ajouter.html'">Ajouter une montre</button>
    </div>

    <table id="montreTable">
        <thead>
            <tr>
                <th>Nom</th>
                <th>Prix</th>
                <th>Description</th>
                <th>Image</th>
                <th>üõ†Ô∏è Actions</th>
            </tr>
        </thead>
        <tbody></tbody>

    </table>

    <!-- MODALE √âDITION -->
    <div id="editModal"
        style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:#000c; z-index:9999; justify-content:center; align-items:center;">
        <div
            style="background:#222; padding:20px; color:white; max-width:500px; width:90%; border-radius:10px; position:relative;">
            <h2>Modifier la montre</h2>
            <form id="editForm">
                <input type="hidden" name="index" />
                <label>Nom <input type="text" name="nom" required></label>
                <label>Prix <input type="number" name="prix" required></label>
                <label>Description <textarea name="description" rows="3" required></textarea></label>
                <div>
                    <label>Image 1 <br><img id="imgPreview1" src="" height="50"><br><input type="file" name="image1"
                            accept="image/*"></label><br>
                    <label>Image 2 <br><img id="imgPreview2" src="" height="50"><br><input type="file" name="image2"
                            accept="image/*"></label><br>
                    <label>Image 3 <br><img id="imgPreview3" src="" height="50"><br><input type="file" name="image3"
                            accept="image/*"></label><br>
                    <label>Image 4 <br><img id="imgPreview4" src="" height="50"><br><input type="file" name="image4"
                            accept="image/*"></label>
                </div>
                <button type="submit">üíæ Enregistrer</button>
                <button type="button" onclick="closeEditModal()">‚ùå Annuler</button>
            </form>
        </div>
    </div>





    <script src="js/config.js"></script>
    <script>
        let montres = [];

        async function fetchData() {
            try {
                const res = await fetch(GOOGLE_API_URL);
                montres = await res.json();
                displayTable();
            } catch (e) {
                alert("Erreur de chargement : " + e);
            }
        }

        function displayTable() {
            const tbody = document.querySelector("#montreTable tbody");
            tbody.innerHTML = "";
            montres.forEach((m, index) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
      <td>${m.nom}</td>
      <td>${m.prix} ‚Ç¨</td>
      <td>${m.description}</td>
      <td><img src="${m.image2}" alt="${m.nom}"></td>
     <td>
        <button onclick="openEditModal(${index})">üìù</button>
        <button onclick="openEditImagesModal(${index})">üñºÔ∏è</button>
        <button onclick="deleteMontre(${index})">üóëÔ∏è</button>
    </td>

    `;
                tbody.appendChild(tr);
            });
        }

        function deleteMontre(index) {
            if (!confirm("Supprimer cette montre ?")) return;

            fetch(GOOGLE_API_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "delete",
                    id: index
                })
            })
                .then(res => res.text())
                .then(msg => {
                    alert("‚õîÔ∏è Montre supprim√©e : " + msg);
                    fetchData(); // recharge
                })
                .catch(err => {
                    alert("Erreur : " + err);
                });
        }

        function downloadCSV() {
            const headers = ["id", "nom", "prix", "description", "image1", "image2", "image3", "image4", "images"];
            const rows = montres.map(r =>
                headers.map(h => {
                    const value = r[h];
                    const str = typeof value === 'string'
                        ? value
                        : typeof value === 'number'
                            ? value.toString()
                            : JSON.stringify(value);
                    return `"${str.replace(/"/g, '""')}"`;
                }).join(",")
            );
            const csvContent = [headers.join(","), ...rows].join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "montres.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function uploadCSV() {
            const fileInput = document.getElementById("csvFile");
            const file = fileInput.files[0];

            if (!file) {
                alert("Veuillez d'abord choisir un fichier CSV !");
                return;
            }

            const formData = new FormData();
            formData.append("csvFile", file);

            fetch("upload.php", {
                method: "POST",
                body: formData
            })
                .then(res => res.text())
                .then(msg => {
                    alert(msg);
                    fileInput.value = "";
                    fetchData();
                })
                .catch(err => {
                    alert("Erreur lors de l'envoi : " + err);
                });
        }

        window.onload = fetchData;


        function openEditModal(index) {
            const montre = montres[index];
            const form = document.getElementById("editForm");

            form.index.value = index;
            form.nom.value = montre.nom;
            form.prix.value = montre.prix;
            form.description.value = montre.description;

            document.getElementById("imgPreview1").src = montre.image1;
            document.getElementById("imgPreview2").src = montre.image2;
            document.getElementById("imgPreview3").src = montre.image3;
            document.getElementById("imgPreview4").src = montre.image4;

            document.getElementById("editModal").style.display = "flex";
        }

        function closeEditModal() {
            document.getElementById("editModal").style.display = "none";
            document.getElementById("editForm").reset();
        }


        function closeEditModal() {
            document.getElementById("editModal").style.display = "none";
        }

        document.getElementById("editForm").addEventListener("submit", async function (e) {
            e.preventDefault();
            const form = e.target;
            const index = form.index.value;

            const old = montres[index];

            const formData = new FormData();
            const imageForm = new FormData();

            // Champs texte
            formData.append("action", "edit");
            formData.append("id", index);
            formData.append("nom", form.nom.value);
            formData.append("prix", form.prix.value);
            formData.append("description", form.description.value);

            // Images
            for (let i = 1; i <= 4; i++) {
                const file = form[`image${i}`].files[0];
                if (file) {
                    const filename = "images/" + file.name;
                    formData.append(`image${i}`, filename);
                    imageForm.append(`image${i}`, file);
                } else {
                    formData.append(`image${i}`, old[`image${i}`]);
                }
            }

            // Upload images si nouvelles
            if (imageForm.has("image1") || imageForm.has("image2") || imageForm.has("image3") || imageForm.has("image4")) {
                await fetch("upload-images.php", {
                    method: "POST",
                    body: imageForm
                });
            }

            // Envoi au Google Sheet
            fetch(GOOGLE_API_URL, {
                method: "POST",
                body: formData
            })
                .then(res => res.text())
                .then(msg => {
                    alert("‚úÖ Modifications enregistr√©es : " + msg);
                    closeEditModal();
                    fetchData();
                })
                .catch(err => {
                    alert("Erreur modification : " + err);
                });
        });


        function replaceCSVFromData() {
  const headers = ["id", "nom", "prix", "description", "image1", "image2", "image3", "image4", "images"];
  const rows = montres.map((m, i) =>
    headers.map(h => {
      const value = h === "id" ? i : (m[h] || "");
      const str = typeof value === 'string'
        ? value
        : typeof value === 'number'
        ? value.toString()
        : JSON.stringify(value);
      return `"${str.replace(/"/g, '""')}"`;
    }).join(",")
  );
  const csvContent = [headers.join(","), ...rows].join("\n");
  const blob = new Blob([csvContent], { type: 'text/csv' });
  const formData = new FormData();
  formData.append("csvFile", blob, "montres.csv");

  fetch("upload.php", {
    method: "POST",
    body: formData
  })
    .then(res => res.text())
    .then(msg => {
      alert("‚úÖ Fichier CSV mis √† jour sur le serveur :\n" + msg);
    })
    .catch(err => {
      alert("‚ùå Erreur lors de l'envoi : " + err);
    });
}

    </script>
</body>

</html>