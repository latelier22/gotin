<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <title>CRUD Montres</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      background: #111;
      color: #FFD700;
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }

    table {
      margin: auto;
      border-collapse: collapse;
      width: 95%;
      background: #222;
      color: white;
    }

    th,
    td {
      border: 1px solid #555;
      padding: 10px;
    }

    img {
      height: 100px;
      cursor: pointer;
      margin: 2px;
      border-radius: 5px;
    }

    button {
      padding: 8px 15px;
      margin: 5px;
      font-weight: bold;
      background: #FFD700;
      color: #111;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .thumbs img:hover {
      transform: scale(1.1);
    }

    #spinner {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    #spinner div {
      border: 6px solid #FFD700;
      border-top: 6px solid transparent;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>

  <h1>Gestion des produits</h1>

  <div>

    <button
      onclick="window.open('https://docs.google.com/spreadsheets/d/1RImwBSEucX0d6chHduucER-GVvM_nzlSFmvAjlQnScg/edit?usp=sharing', '_blank')">GoogleSheet</button>

    <button onclick="window.location.href='import.php'">‚¨ÖÔ∏è Importer de GoogleSheet</button>
    <button onclick="envoyerVersGoogle()">‚û°Ô∏è Exporter vers GoogleSheet</button>
    <button onclick="downloadCSV()">‚¨áÔ∏è T√©l√©charge CSV GoogleSheet</button>
    <button onclick="downloadZip()">T√©l√©charger ZIP</button>
    <button onclick="replaceCSVFromData()">üì§ Exporter Google vers serveur</button>
    <button onclick="window.location.href='index.html'">üè† Voir les montres</button>
    <button onclick="openAddModal()">‚ûï Ajouter une montre</button>

  </div>
  <div>
    <div id="filters" style="margin-bottom: 20px;">
      <button onclick="filterCategory('All')">üì¶ Tous</button>
      <button onclick="filterCategory('Montres')">‚åö Montres</button>
      <button onclick="filterCategory('Chaussures')">üëü Chaussures</button>
      <button onclick="filterCategory('Autres')">üìÅ Autres</button>
    </div>

  </div>

  <table>
    <thead>
      <tr>
        <th>Reference</th>
        <th>Nom</th>
        <th>Prix</th>
        <th>Description</th>
        <th>Images</th>
        <th>Actions</th>
        <th>Cat√©gorie</th>
      </tr>
    </thead>
    <tbody id="montreTable"></tbody>
  </table>

  <!-- Modale Slider -->
  <div id="modal"
    style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.85); z-index:1000; justify-content:center; align-items:center; flex-direction:column;">
    <button onclick="closeModal()" style="position:absolute; top:10px; right:10px;">‚úñ</button>
    <img id="modal-image" style="max-width:100vw; max-height:100vh; margin-bottom:10px;" />
    <div>
      <button onclick="prevImage()">‚¨ÖÔ∏è</button>
      <button onclick="nextImage()">‚û°Ô∏è</button>
    </div>
  </div>

  <!-- Modale Formulaire -->
  <div id="formModal"
    style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:#000c; z-index:9999; justify-content:center; align-items:center;">
    <form id="formMontre"
      style="background:#222; padding:20px; color:white; max-width:500px; width:90%; border-radius:10px;"
      enctype="multipart/form-data">
      <input type="hidden" name="id">
      <label>Reference : <input type="text" name="reference" required></label><br>
      <label>Nom : <input type="text" name="nom" required></label><br>
      <label>Prix : <input type="number" name="prix" required></label><br>
      <label>Description : <textarea name="description" rows="3" required></textarea></label><br>
      <label>Image 1 : <input type="file" name="image1" accept="image/*"></label><br>
      <label>Image 2 : <input type="file" name="image2" accept="image/*"></label><br>
      <label>Image 3 : <input type="file" name="image3" accept="image/*"></label><br>
      <label>Image 4 : <input type="file" name="image4" accept="image/*"></label><br>
      <label>Cat√©gorie :
        <select name="categorie">
          <option>Montres</option>
          <option>Chaussures</option>
          <option>Autres</option>
        </select>
      </label><br>
      <button type="submit">üíæ Enregistrer</button>
      <button type="button" onclick="closeModalForm()">‚ùå Annuler</button>
    </form>
  </div>

  <div id="spinner">
    <div></div>
  </div>

  <script src="js/config.js"></script>
  <script>
    let currentCategory = "All";

    const API_URL = "api.php";
    let montres = [];
    let currentImages = [];
    let currentIndex = 0;
    let editing = false;

    function showSpinner() { document.getElementById("spinner").style.display = "flex"; }
    function hideSpinner() { document.getElementById("spinner").style.display = "none"; }

    async function fetchMontres() {
      showSpinner();
      const res = await fetch(API_URL + "?action=list");
      montres = await res.json();
      hideSpinner();
      displayMontres();
    }

    function displayMontres() {
      const tbody = document.getElementById("montreTable");
      tbody.innerHTML = "";

      const filtered = currentCategory === "All"
        ? montres
        : montres.filter(m => m.categorie === currentCategory);

      filtered.forEach((m, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
        <td>${m.reference}</td>
      <td>${m.nom}</td>
      <td>${m.prix} ‚Ç¨</td>
      <td>${m.description}</td>
      <td>
        <div class="thumbs">
          ${[m.image1, m.image2, m.image3, m.image4].map((img, i) =>
          `<img src="${img}" onclick="openModal([${[m.image1, m.image2, m.image3, m.image4].map(i => `'${i}'`).join(',')}], ${i})">`).join('')
          }
        </div>
      </td>
      <td>
        <button onclick="openEditModal(${index})">üìù</button>
        <button onclick="deleteMontre(${m.id})">üóëÔ∏è</button>
      </td>
      <td>${m.categorie}</td>`;
        tbody.appendChild(tr);
      });
    }

    function filterCategory(cat) {
      currentCategory = cat;
      displayMontres();
    }


    function openModal(images, start) {
      currentImages = images;
      currentIndex = start;
      document.getElementById("modal-image").src = images[start];
      document.getElementById("modal").style.display = "flex";
    }
    function closeModal() { document.getElementById("modal").style.display = "none"; }
    function prevImage() {
      currentIndex = (currentIndex - 1 + currentImages.length) % currentImages.length;
      document.getElementById("modal-image").src = currentImages[currentIndex];
    }
    function nextImage() {
      currentIndex = (currentIndex + 1) % currentImages.length;
      document.getElementById("modal-image").src = currentImages[currentIndex];
    }

    function openAddModal() {
      editing = false;
      const form = document.getElementById("formMontre");
      form.reset();
      form.id.value = "";
      document.getElementById("formModal").style.display = "flex";
    }

    function openEditModal(index) {
      editing = true;
      const m = montres[index];
      const form = document.getElementById("formMontre");
      form.id.value = m.id;
      form.reference.value = m.reference; // <-- AJOUT ICI
      form.nom.value = m.nom;
      form.prix.value = m.prix;
      form.description.value = m.description;
      form.categorie.value = m.categorie; // <-- AJOUT ICI
      document.getElementById("formModal").style.display = "flex";
    }

    function closeModalForm() {
      document.getElementById("formModal").style.display = "none";
    }

    async function deleteMontre(id) {
      if (!confirm("Confirmer suppression ?")) return;
      const fd = new FormData();
      fd.append("action", "delete");
      fd.append("id", id);
      showSpinner();
      const res = await fetch(API_URL, { method: "POST", body: fd });
      hideSpinner();
      <!-- alert(await res.text()); -->
      fetchMontres();
    }

    document.getElementById("formMontre").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;
      const dataForm = new FormData(form);
      const imageForm = new FormData();
      const imagePaths = [];

      for (let i = 1; i <= 4; i++) {
        const file = form[`image${i}`].files[0];
        if (file) {
          imageForm.append(`image${i}`, file);
          imagePaths.push("images/" + file.name);
        } else {
          imagePaths.push(editing ? montres.find(m => m.id == form.id.value)[`image${i}`] : "");
        }
      }

      if (imageForm.has("image1") || imageForm.has("image2") || imageForm.has("image3") || imageForm.has("image4")) {
        await fetch("upload-images.php", { method: "POST", body: imageForm });
      }

      dataForm.append("image1", imagePaths[0]);
      dataForm.append("image2", imagePaths[1]);
      dataForm.append("image3", imagePaths[2]);
      dataForm.append("image4", imagePaths[3]);
      dataForm.append("action", editing ? "edit" : "add");

      showSpinner();
      const res = await fetch(API_URL, { method: "POST", body: dataForm });
      hideSpinner();

      closeModalForm();
      fetchMontres();
    });

    window.onload = fetchMontres;
  </script>

  <script>
    async function envoyerVersGoogle() {
      const payload = {
        action: "replaceAll",
        values: montres.map((m, i) => [
          i,
          m.nom || "",
          m.prix || 0,
          m.description || "",
          m.image1 || "",
          m.image2 || "",
          m.image3 || "",
          m.image4 || ""
        ])
      };

      console.log("üì§ Envoi vers GoogleSheet :", payload);

      try {
        const res = await fetch(GOOGLE_API_URL, {
          method: "POST",
          body: JSON.stringify(payload)
        });

        const txt = await res.text();
        console.log("‚úÖ R√©ponse GoogleSheet :", txt);
        alert("‚úÖ R√©sultat : " + txt);
      } catch (err) {
        alert("‚ùå Erreur d'envoi : " + err);
      }
    }


    function downloadCSV() {
      const headers = ["id", "nom", "prix", "description", "image1", "image2", "image3", "image4"];
      const rows = montres.map(r =>
        headers.map(h => {
          const value = r[h];
          const str = typeof value === 'string'
            ? value
            : typeof value === 'number'
              ? value.toString()
              : JSON.stringify(value);
          return `"${str.replace(/"/g, '""')}"`;
        }).join(",")
      );
      const csvContent = [headers.join(","), ...rows].join("\n");
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "montres.csv";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }


    function replaceCSVFromData() {
      const headers = ["id", "nom", "prix", "description", "image1", "image2", "image3", "image4"];
      const rows = montres.map((m, i) =>
        headers.map(h => {
          const value = h === "id" ? i : (m[h] || "");
          const str = typeof value === 'string'
            ? value
            : typeof value === 'number'
              ? value.toString()
              : JSON.stringify(value);
          return `"${str.replace(/"/g, '""')}"`;
        }).join(",")
      );
      const csvContent = [headers.join(","), ...rows].join("\n");
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const formData = new FormData();
      formData.append("csvFile", blob, "montres.csv");
      showSpinner();
      fetch("upload.php", {
        method: "POST",
        body: formData
      })
        .then(res => res.text())
        .then(msg => {
          hideSpinner();
          alert("‚úÖ Fichier CSV mis √† jour sur le serveur :\n" + msg);
        })
        .catch(err => {
          hideSpinner();
          alert("‚ùå Erreur lors de l'envoi : " + err);
        });
    }

  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip-utils/0.1.0/jszip-utils.min.js"></script>


  <script>
    async function downloadZip() {
      const zip = new JSZip();

      // Liste des fichiers √† inclure
      const files = [
        { path: 'data/montres.csv', name: 'montres.csv' },
        { path: 'index.html', name: 'index.html' }
      ];

      // Fetch and add each file to the ZIP
      for (const file of files) {
        try {
          const response = await fetch(file.path);
          if (!response.ok) throw new Error(`Erreur de chargement : ${file.path}`);
          const content = await response.text();
          zip.file(file.name, content);
        } catch (err) {
          alert(err.message);
          return;
        }
      }

      // G√©n√®re et t√©l√©charge le ZIP
      zip.generateAsync({ type: 'blob' })
        .then(function (content) {
          const a = document.createElement('a');
          a.href = URL.createObjectURL(content);
          a.download = 'fichiers_montres.zip';
          a.click();
        });
    }


  </script>

</body>

</html>